version: "3.5"
services:
  # This is kept until isard-stats is fixed, then it will be comented out
  # isard-stats:
  #   image: ${DOCKER_IMAGE_PREFIX}stats:${DOCKER_IMAGE_TAG-latest}
  #   container_name: isard-stats
  #   logging:
  #     options:
  #       max-size: "100m"
  #   env_file:
  #     - .env
  #   networks:
  #     isard-network: {}
  #   restart: "no"
  #   depends_on:
  #     - isard-hypervisor

  isard-stats-go:
    image: ${DOCKER_IMAGE_PREFIX}stats-go:${DOCKER_IMAGE_TAG-latest}
    container_name: isard-stats-go
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
    restart: "no"
    networks:
      isard-network: {}
    env_file:
      - .env
    environment:
      - FLAVOUR=${FLAVOUR:-all-in-one}

  isard-stats-glances:
    image: ${DOCKER_IMAGE_PREFIX}stats-glances:${DOCKER_IMAGE_TAG-latest}
    container_name: isard-stats-glances
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
    restart: "no"
    network_mode: host
    privileged: true
    pid: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /opt/isard:/opt/isard:ro
      - /opt/isard/templates:/opt/isard/templates:ro
      - /opt/isard/groups:/opt/isard/groups:ro
      - /opt/isard/media:/opt/isard/media:ro
      - /:/disk:ro
    env_file:
      - .env
    extra_hosts:
      - "host.docker.internal:host-gateway"

  isard-grafana-agent:
    container_name: isard-grafana-agent
    image: grafana/agent:v0.24.2
    volumes:
      - ${BUILD_ROOT_PATH}/docker/grafana-agent/config.yml:/etc/agent/config.yml
      - /opt/isard-local/stats/grafana-agent:/tmp/agent/data
      - /var/log:/var/log
      - /var/lib/docker/containers:/var/lib/docker/containers
    networks:
      isard-network:
        ipv4_address: ${DOCKER_NET:-172.31.255}.69
    extra_hosts:
      - "host.docker.internal:host-gateway"
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
    restart: "no"
    command: -config.file=/etc/agent/config.yml -config.expand-env=true --metrics.wal-directory=/tmp/agent/data
    env_file:
      - .env
    environment:
      - PROMETHEUS_ADDRESS=${PROMETHEUS_ADDRESS:-http://isard-prometheus:9090}
      - LOKI_ADDRESS=${LOKI_ADDRESS:-http://isard-loki:3100}
